{% include 'header.twig' %}
<style>
.body {
    background-image: url('app/views/xblur/image/Background.png');
    background-position: 0px 0px;
    background-repeat: repeat;
    background-size: 300%;
    width: 100%;
}
</style>

<div class="wrapper-content">
    <div class="wrapper-content__header"></div>
    <div class="wrapper-content__body">
        <div id="block_93">
            <div class="add-funds__form">
                <div class="bg"></div>
                <div class="divider-top"></div>
                <div class="divider-bottom"></div>
                <div class="container">
                    <div class="row">
                        {% if contentText %}
                        <div class="col-lg-12 mt-2">
                            <div class="super-lud mb-2">
                                {{ contentText }}
                            </div>
                        </div>
                        {% endif %}

                        <div class="col-lg-7">
                            <div class="component_form_group component_card component_radio_button">
                                <div class="component_card">
                                    <div class="super-lud mt-2 mb-2">
                                        <form method="post" id="addfundsForm" action="/addfunds">
                                            <div class="form-group">
                                                <label for="method" class="control-label">{{ lang['addfunds.method'] }}</label>
                                                <select class="form-control" id="payment_method" name="payment_type">
                                                    {% for method in site["paymentMethods"] %}
                                                        <option value="{{ method['id'] }}">{{ method['name'] }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div id="addfunds_fields"></div>
                                        </form>
                                        <div id="formSubmitResponseMessage"></div>
                                        <div id="formSubmitResponseContent"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-5 mt-2">
                            <div class="component_content_card component_content_button component_content_headers">
                                <div class="table-wr table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Date</th>
                                                <th>Method</th>
                                                <th>Amount</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for payment in payments %}
                                            <tr>
                                                <td>{{ payment['id'] }}</td>
                                                <td>{{ payment['date'] }}</td>
                                                <td>{{ payment['name'] }}</td>
                                                <td>{{ payment['amount'] }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="divider-top"></div>
                <div class="divider-bottom"></div>
                <div class="container ludd">
                    {% if contentText2 %}
                    <div class="super-lud mt-2 mb-4">
                        {{ contentText2 }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% include 'footer.twig' %}

<script>
var paymentMethods = {{ site["paymentMethodsJSON"] }};
const addfundsRoute = "/addfunds";

function addfundsInit() {
    var fields = $("#addfunds_fields");
    var selectedMethod = $("#payment_method").val();
    var instructions = paymentMethods[selectedMethod][0].instructions;
    var methodName = paymentMethods[selectedMethod][0].name;

    $.ajax({
        url: addfundsRoute,
        data: "action=getForm&selectedMethod=" + selectedMethod,
        type: "POST",
        success: function (json) {
            if (json.success == true) {
                var html = "";
                if (instructions.length > 0) {
                    html += `<div class="form-group">
                                <label class="control-label">Instructions</label>
                                <div class="panel-body border-solid border-rounded">${instructions}</div>
                             </div>`;
                }

                html += json.content;

                // If method is Puffx Pay
                if (methodName === "Puffx Pay") {
                    html += `
                        <div class="form-group">
                            <label>Amount</label>
                            <input type="number" class="form-control" id="puffxAmount" placeholder="Enter Amount" required>
                        </div>
                        <button type="button" id="puffxPayBtn" class="btn btn-primary mt-2">Pay Now</button>
                    `;
                }

                fields.html(html);
                extraFeeInit(selectedMethod);
            }
        }
    });
}

function extraFeeInit(method) {
    var fee = parseFloat(paymentMethods[method][0].fee).toFixed(2);
    var fields = $("#fee_fields");
    if (fee > 0) {
        fields.html('<div class="form-group"><label class="control-label">Extra fee</label><input type="text" class="form-control" id="methodExtraFee" disabled value="0.00"/></div><div class="form-group"><label class="control-label">Total Amount</label><input type="text" id="totalAmount" class="form-control" disabled value="0.00" /></div>');
    }
}

function preparePrice(t) {
    n = 2;
    var r = (t = $.trim(t.toString().replace(",", "."))).split(".");
    if (r[1]) {
        r[1] = r[1].replace(/0+$/g, "");
        r[1].length > n && (n = r[1].length > 2 ? 2 : r[1].length);
    }
    t = parseFloat(t).toFixed(n);
    if (t >= 1000) {
        t = t.toString().replace(/(\d)(?=(\d\d\d)+([^\d]|$))/g, "$1");
    }
    t = t.toString().replace(/\.(\d+)$/g, "." + "$1");
    return t.toFixed(n);
}

$(document).ready(function () {
    addfundsInit();

    $(document).on("keyup", "#paymentAmount", function () {
        var selectedMethod = $("#payment_method").val();
        var amount = parseFloat($(this).val());
        var feePercentage = parseFloat(paymentMethods[selectedMethod][0].fee);
        var feeInput = $("#methodExtraFee");
        var totalAmountInput = $("#totalAmount");
        var fee = amount * (feePercentage / 100);
        feeInput.val(preparePrice(fee));
        totalAmountInput.val(preparePrice(amount + fee));
    });

    $("#payment_method").change(function () {
        addfundsInit();
    });

    $("#addfundsForm").submit(function (e) {
        e.preventDefault();
        var data = $(this).serialize();

        $.ajax({
            url: addfundsRoute,
            data: data,
            type: "POST",
            success: function (json) {
                var msgDiv = $("#formSubmitResponseMessage");
                if (json.success == true) {
                    msgDiv.html('<div class="alert alert-success alert-dismissible fade show mt-2" role="alert">' + json.message + '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button></div>');
                    $("#formSubmitResponseContent").html(json.content);
                } else {
                    msgDiv.html('<div class="alert alert-danger alert-dismissible fade show mt-2" role="alert">' + json.message + '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">×</span></button></div>');
                }
            }
        });
    });

    // Puffx Pay button action
    $(document).on("click", "#puffxPayBtn", function () {
        var amount = $("#puffxAmount").val();
        var orderId = "WHMCS_" + new Date().getTime();

        if (!amount || parseFloat(amount) <= 0) {
            alert("Please enter a valid amount.");
            return;
        }

        // Redirect to payment
        window.location.href = `/app/views/xblur/puffxpay/puffxpay.php?amount=${amount}&user={{ user['username'] }}`;
    });
});
</script>
